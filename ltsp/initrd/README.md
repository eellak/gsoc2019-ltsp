# Initramfs notes for LTSP
Tasks that need to run in the initramfs:
 * Work around initramfs-tools/dracut issues (e.g. nbd0p1)
 * Overlay root:
   * Do the tmpfs overlay in /run/initramfs/cow, because systemd doesn't
     unmount /run/initramfs/* on shutdown.
   * Put the LTSP code in the tmpfs overlay, because initramfs-tools uses
     noexec for /run/initramfs. Then symlink to /run/ltsp for easier paths.
 * Move $rootmnt/sbin/init to init.real; symlink it to /run/ltsp/ltsp.sh;
   then from the ltsp-init tool, put init.real back.
 * Support fancy mounting, e.g. squashfs root over NFS
 * Do we need CMD_INITRD_BOTTOM_xx?

Tasks that shouldn't run in the initramfs:
 * mkswap isn't generally available; activate swap later
 * If 00-overlay is ever needed, we'll manage. Don't care about it now.
 * All the ltsp_config.d and init-ltsp.d code will run from the ltsp init tool.
 TO READ: https://www.slax.org/blog/24229-Clean-shutdown-with-systemd.html

## Initramfs-tools
Files: conf/*, scripts/*
Busybox ln doesn't support -r. Partprobe isn't available on Debian.

### Generating
$ apt install nbd-client
$ update-initramfs -u

### /proc/cmdline
nbdroot=server:/path

## Dracut
Files: usr/*
On fedora 30, it's based on Bash and GNU tools. It's missing the following:
    basename blockdev busybox chmod cpio cut date dd env expr find hostname
    ipconfig mkswap mktemp modprobe>aoe nbd-client nc netstat nfsmount
    partprobe pgrep pidof pivot_root rmdir run-parts seq ss sync touch wget
    which
It does have these though:
    blkid dhclient ip
Wait wait, these are only missing on the default, host-only initramfs.
In the one that includes nbd-client, it's only missing these:
    busybox cut date env hostname ipconfig mkswap mktemp nc netstat nfsmount
    partprobe pgrep pidof pivot_root rmdir run-parts seq ss sync touch wget
In the rescue one, it probably contains support for nfs root, and these:
    basename chmod expr netstat

### Dracut notes
/lib/dracut/modules.txt contains the dracut modules (nfs, nbd etc)
/lib/dracut/hooks:
cleanup emergency mount pre-mount pre-shutdown pre-udev shutdown-emergency
cmdline initqueue netroot pre-pivot pre-trigger shutdown
Let's try pre-pivot..

### Generating
$ yum install nbd
$ dracut --list-modules
$ dracut [--kver=$(uname -r)] --no-hostonly --force --[force-]add "nbd nfs squash dmsquash-live" --add-drivers "nbd aoe squashfs OVERLAY"
 # network base overlay:unneeded, I pull it from /sysroot

### Dracut-rescue
Dracut with the command line above ^ is 67MB. There's also a "rescue" version
that comes with Fedora, that seems to have AoE and NFS support out of the box.
Could be worth exploring, for ltsp-booting stock fedora images.

### /proc/cmdline
dracut-state with netroot:
netroot=nbd:blabla
root=block:/dev/root
and fails.

dracut-state with root=nbd:bla
same! i pass root=, it becomes netroot=
but, it works!

root=/dev/nbd0 netroot=bla
root=block:/dev/nbd0
and hangs


# Other notes
mount --make-private
Fetch ltsp.img/ltsp-client.sh via nbd (!)
  + This even allows ltsp.img to be autogenerated by an nbd-server script
    on demand, so that users don't need to run ltsp-initrd manually.
  - But this won't work for offline boots. Maybe it can be optional.

# Install 64bit kernel on 32bit installation
dpkg --add-architecture amd64
apt update
apt install linux-image-4.15.0-20-lowlatency:amd64 linux-headers-4.15.0-20-lowlatency:amd64
apt install --purge shim-signed:amd64
